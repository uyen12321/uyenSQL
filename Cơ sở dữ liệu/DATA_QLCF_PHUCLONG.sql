CREATE DATABASE QL_KH_CFPHUCLONG
USE QL_KH_CFPHUCLONG
GO

CREATE TABLE CHINHANH
(
	MaCN VARCHAR (20) NOT NULL CONSTRAINT PK_KEYCN PRIMARY KEY,
	TenCN NVARCHAR (30) NOT NULL,
	DiaChi NVARCHAR (100),
	SDT NVARCHAR (11)
)

CREATE TABLE KHACHHANG
(
	MaKH VARCHAR (20) NOT NULL CONSTRAINT PK_KEYKH PRIMARY KEY,
	HoKH NVARCHAR (150) NOT NULL,
	TenKH NVARCHAR (150) NOT NULL,
	NgaySinh DATE,
	GioiTinh NVARCHAR(10), 
	DiaChi NVARCHAR (100),
	SDT NVARCHAR (11),
	Email NVARCHAR (50),
	CMND NVARCHAR (12),
	ThanhVien NVARCHAR (50),
	CONSTRAINT CK_GioiTinhKH CHECK (GioiTinh IN (N'Nam', N'Nữ', N'Khác')),
)

CREATE TABLE THETHANHVIEN
(
	SOTHE INT CONSTRAINT PK_KEYTTV PRIMARY KEY,
	MAKH VARCHAR (20) NOT NULL,
	TONGDIEM INT NOT NULL CONSTRAINT DF_TD DEFAULT 0,
	CONSTRAINT FK_TV_KH FOREIGN KEY (MAKH) REFERENCES KHACHHANG (MAKH)
)

CREATE TABLE LOAIMON
(
	MALOAIMON VARCHAR (20) NOT NULL CONSTRAINT PK_KEYLM PRIMARY KEY,
	TENLOAIMON NVARCHAR (150) NOT NULL,
)

CREATE TABLE MON
(
	MAMON VARCHAR (20) NOT NULL CONSTRAINT PK_KEYM PRIMARY KEY,
	TENMON NVARCHAR (150) NOT NULL,
	MALOAIMON VARCHAR (20) NOT NULL,
	GIABAN FLOAT NOT NULL,
	CONSTRAINT FK_MON_LM FOREIGN KEY (MALOAIMON) REFERENCES LOAIMON (MALOAIMON),
)

CREATE TABLE PHUCAP
(
	MAPHUCAP VARCHAR (20) NOT NULL CONSTRAINT PK_KEYPC PRIMARY KEY,
	TENPHUCAP NVARCHAR(120) NOT NULL,
	TIEN_HOTRO FLOAT NOT NULL,
)

CREATE TABLE NHANVIEN
(
	MaNV VARCHAR (20) NOT NULL CONSTRAINT PK_KEYNV PRIMARY KEY,
	MaCN VARCHAR (20) NOT NULL,
	HoNV NVARCHAR (50),
	TenNV NVARCHAR (50),
	NgaySinh DATE,
	GioiTinhNV NCHAR (10),
	CMND NVARCHAR (12),
	DiaChi NVARCHAR (100),
	SDT NVARCHAR (11),
	Email NVARCHAR (50),
	LUONGCB FLOAT,
	CONSTRAINT FK_NV_CN FOREIGN KEY (MaCN) REFERENCES CHINHANH (MaCN),
)


CREATE TABLE CT_HUONGPHUCAP
(
	MAPHUCAP VARCHAR (20) NOT NULL,
	MANV VARCHAR (20) NOT NULL,
	CONSTRAINT PK_CTPC PRIMARY KEY (MAPHUCAP,MANV),
	CONSTRAINT FK_PC_CTPC FOREIGN KEY (MAPHUCAP) REFERENCES PHUCAP (MAPHUCAP),
	CONSTRAINT FK_NV_CTPC FOREIGN KEY (MANV) REFERENCES NHANVIEN(MANV),
)


CREATE TABLE HOADON
(
	SOHD VARCHAR (20) NOT NULL CONSTRAINT PK_KEYHD PRIMARY KEY,
	MANV VARCHAR (20) NOT NULL,
	MAKH VARCHAR (20) NOT NULL,
	NGAYLAP DATE CONSTRAINT DF_NL DEFAULT GETDATE(),
	UUDAI INT NOT NULL CONSTRAINT DF_UUDAI DEFAULT 0,
	TONGTIEN FLOAT,
	CONSTRAINT FK_HD_NV FOREIGN KEY (MANV) REFERENCES NHANVIEN (MANV),
	CONSTRAINT FK_HD_KH FOREIGN KEY (MAKH) REFERENCES KHACHHANG(MAKH),
)

CREATE TABLE CT_HOADON
(
	SOHD VARCHAR (20) NOT NULL,
	MAMON VARCHAR (20) NOT NULL,
	SOLUONG INT NOT NULL,
	THANHTIEN FLOAT,
	CONSTRAINT FK_CTHD_HD FOREIGN KEY (SOHD) REFERENCES HOADON(SOHD),
	CONSTRAINT FK_CTHD_M FOREIGN KEY (MAMON) REFERENCES MON(MAMON),
	CONSTRAINT PK_KEYCTHD PRIMARY KEY(SOHD,MAMON)
)

----DỮ LIỆU
INSERT INTO CHINHANH(MaCN,TenCN,DiaChi,SDT)
VALUES('CN001',N'Coffe Phúc Long Q1',N'197 Đinh Tiên Hoàng, Phường Tân Định, Q1','0123456789'),
	('CN002',N'Coffe Phúc Long Q3',N'117, Nguyễn Đình Chiểu,Q3','0987654321'),
	('CN003',N'Coffe Phúc Long Q4',N'350, Lê Văn Sỹ,Q4','0123456789'),
	('CN004',N'Coffe Phúc Long Q.Tân Phú',N'140 Lê Trọng Tấn, Tân Phú','0123456789'),
	('CN005',N'Coffe Phúc Long Q5',N'382 Trần Hưng Đạo, Q5','06427279216'),
	('CN006',N'Coffe Phúc Long Q6',N'592 Lê Văn Lương, Q6','0964737252'),
	('CN007',N'Coffe Phúc Long Q.Thủ Đức',N'Số 88 Song Hành, phường An Phú, TP.Thủ Đức','01463731681'),
	('CN008',N'Coffe Phúc Long Q.Tân Bình',N'Quan Trung, Tầng 1 Vincom, Tân Bình','07362969432')


set dateformat dmy;
INSERT INTO KHACHHANG(MaKH,HoKH,TenKH,NgaySinh,GioiTinh,DiaChi,SDT,Email,CMND)
VALUES('KH001',N'Nguyễn Tiến',N'Luật','12/05/1992',N'Nam',N'134 Nguyễn Xuân Thái, Tân Phú','0986306331','luat@gmail.com','1686514490'),
	('KH002',N'Nguyễn Anh',N'Tuấn','2/5/1979',N'Nam',N'222 Lê Văn Sỹ, Phường 14, Quận 3','0933737485','tuannguyen@gmail.com','91853757'),
	('KH003',N'Ngô Vỹ',N'Kiệt','15/1/1985',N'Nam',N'280 An Dương Vương, Phường 4, Q5','090836195','kietngo@gmail.com','903886848'),
	('KH004',N'Trần Thị',N'Hà','4/2/1988',N'Nữ',N'Tòa nhà 15 Lê Thánh Tôn, phường Bến Nghé ','0909714623','hatran@gmail.com','919124901'),
	('KH005',N'Lê Văn',N'Kiên','29/3/1983',N'Nam',N'Toà nhà HMTC TOWER, 22 Lý Tự Trọng, phường Bến Nghé','0903122556','kienle@gmail.com','913801389'),
	('KH006',N'Phạm Ái',N'Lam','29/11/1979',N'Nữ',N'62A Phạm Ngọc Thạch, phường 6, quận 3','098311883','lampham@gmail.com','909714623'),
	('KH007',N'Lâm Thị Họa',N'Mi','19/5/1988',N'Nữ',N'570 Điện Biên Phủ, quận Thanh Khê, thành phố Đà Nẵng','0918129188','milam@gmail.com','938174123'),
	('KH008',N'Hà Văn',N'Tuấn','12/9/1985',N'Nam',N'A2B chung cư Tiến Bộ, Tổ 2, phường Hoàng Văn Thụ','0383874672','tuannguyen@gmail.com','986950840'),
	('KH009',N'Ngô Bá',N'Quát','9/2/1985',N'Nam',N'D46 khu quy hoạch An Sơn, phường 4, TP. Đà Lạt','0982882201','ngoquat@gmail.com','389288634'),
	('KH010',N'Võ Hoài',N'Linh','7/6/1984',N'Nam',N'44/274 Lạch tray, Ngô Quyền, thành phố Hải phòng','0908356130','linhvo@gmail.com','93389842'),
	('KH011',N'Tái Thanh',N'Giang','25/11/1986',N'Nam',N'B68 Bạch Đằng, phường 2, quận Tân Bình','0988805526','giangtai@gmail.com','914162689'),
	('KH012',N'Đào Thị Thu',N'Phương','23/5/1986',N'Nữ',N'Tổ 22, khu phố 3A, phường Thạnh Lộc, quận 12','0918740540','phuongdao@gmail.com','1669788679'),
	('KH013',N'Hữu Văn',N'Phước','22/10/1982',N'Nam',N'Tổ 47, khu phố 4, phường Trung Mỹ Tây, quận 12','084984888','phuochuu@gmail.com','978178764'),
	('KH014',N'Cao Thị Hồng',N'Liên','19/2/1984',N'Nữ',N'Phương Nam, địa chỉ A3 Bạch Đằng, phường 2, quận Tân Bình','0986338854','liencao@gmail.com','979809204'),
	('KH015',N'Nguyễn Thị Ngọc',N'Thủy','8/7/1987',N'Nữ',N'Phạm Văn Hai, quận Tân Bình','0908248238','thuynguyen@gmail.com','905682529'),
	('KH016',N'Võ Minh',N'Khải','17/9/1987',N'Nam',N'Nguyễn Phúc Chu, phường 15, Tân Bình','0903112536','khaivo@gmail.com','982725726'),
	('KH017',N'Châu Gia',N'Kiệt','9/3/1988',N'Nam',N'12A1 Bạch Đằng, phường 2, quận Tân Bình','0903112536','kietchau@gmail.com','937303282'),
	('KH018',N'Võ Vũ Trường',N'Giang','25/7/1988',N'Nam',N'B68 Bạch Đằng, phường 2, quận Tân Bình','0919413401','Giangvo@gmail.com','974131489'),
	('KH019',N'Vũ Văn',N'Hộ','24/10/1985',N'Nam',N'A3 Bạch Đằng, phường 2, quận Tân Bình','0932024158','hovu@gmail.com','984084034'),
	('KH020',N'Thái Thị Thanh',N'Thanh','1/5/1987',N'Nữ',N'Phạm Văn Hai, quận Tân Bình','0918201102','thanhthai@gmail.com','977557349'),
	('KH021',N'Châu Gia',N'Khang','15/7/1976',N'Nam',N'số 90, đường Nguyễn Phúc Chu, phường 15, Tân Bình','094385253','khangchau@gmail.com','1649616718'),
	('KH022',N'Từ Công',N'Khanh','29/10/1980',N'Nam',N'Nguyễn Văn Cự, phường Tân Tạo, quận Bình Tân','0937970960','khanhchau@gmail.com','1272389777'),
	('KH023',N'Lâm Gia',N'Tuấn','15/12/1981',N'Nam',N'phường 6, quận Gò Vấp','0913801389','tuanlam@gmail.com','986958908'),
	('KH024',N'Hồ Văn',N'Cương','5/10/1985',N'Nam',N'251 Quang Trung, phường 10, quận Gò Vấp','01226665770','cuong@gmail.com','1648129157'),
	('KH025',N'Phương Thị Mỹ',N'Chi','17/1/1987',N'Nữ',N' 246, Xô Viết Nghệ Tĩnh phường 21, quận Bình Thạnh.','0908299448','chi@gmail.com','1673433886'),
	('KH026',N'Trần Thị Khánh',N'Kiều','7/12/1987',N'Nữ',N'140 Nguyễn Đỗ Cung, Tân Phú','0859034062','kieu@gmail.com','988753023'),
	('KH027',N'Vũ Phương',N'Anh','25/3/1986',N'Nữ',N'27-28, ngõ 294 Vạn Phúc, Kim Mã','0907636150','anh@gmail.com','1656077115'),
	('KH028',N'Đỗ Nguyễn Thu',N'Phương','15/3/1986',N'Nữ',N' 40 Cao Bá Quát','0983470919','phuong@gmail.com','972907579'),
	('KH029',N'Cao Văn',N'Lầu','10/10/1988',N'Nam',N' 32 Phó Đức Chính','0988541477','lau@gmail.com','904054732'),
	('KH030',N'Nguyễn Sinh',N'Sắc','28/3/1985',N'Nam',N'76 Phạm Huy Thông, Ngọc Khánh','0968068905','sat@gmail.com','1658102387'),
	('KH031',N'Lê Văn',N'Giàu','09/12/2000',N'Nam',N'120 Lê Văn Lương, Q6','0918289858','giaule@gmail.com','98675290')



INSERT INTO NHANVIEN(MaNV,MaCN,HoNV,TenNV,NgaySinh,GioiTinhNV,CMND,DiaChi,SDT,Email,LUONGCB)
VALUES('NV001','CN001',N'Nguyễn Văn',N'Chính','14/3/1983',N'Nam','904690835',N'Hà Nội','0975808375','chinh@gmail.com',8000000),
	('NV002','CN001',N'Phí Thị Mai',N'Dư­ơng','20/9/1987',N'Nữ','979650651',N'Đồng Tháp','01697565952','duong@gmail.com',6000000),
	('NV003','CN001',N'Phạm Anh',N'Dũng','3/6/1985',N'Nam','985587050',N'Long Thành','0918612410','dung@gmail.com',8000000),
	('NV004','CN001',N'Phan Thanh',N'Dũng','29/10/1986',N'Nam','987626642',N'Đồng Nai','0914421796','dungphan@gmail.com',8000000),
	('NV005','CN001',N'D­ơng Hải',N'Đăng','14/3/1982',N'Nam','1248415126',N'Thái Sơn','0976054844','dang@gmail.com',8000000),
	('NV006','CN002',N'Nguyễn Thị',N'Đào','20/12/1984',N'Nữ','167423824',N'Cao Bằng','0986109656','daonguyen@gmail.com',8000000),
	('NV007','CN002',N'Nguyễn Thị Tuyết',N'Đan','27/5/1988',N'Nữ','975236626',N'Long Khánh','01643845060','dan@gmail.com',6000000),
	('NV008','CN002',N'Phạm Thị',N'Điệp','10/3/1985',N'Nữ','1253212277',N'Đồng Tháp','01674518996','diep@gmail.com',8000000),
	('NV009','CN002',N'Nguyễn Hữu',N'Đoàn','11/6/1982',N'Nam','983535586',N'Vĩnh Long','0975861551','doan@gmail.com',8000000),
	('NV010','CN002',N'Nguyễn',N'Gấm','1/12/1982',N'Nam','904567146',N'Cần Thơ','0936053286','gam@gmail.com',6000000),
	('NV011','CN003',N'Hoàng Thu',N'Hằng','2/1/1985',N'Nữ','976739552',N'Đồng Tháp','0974131489','hang85@gmail.com',8000000),
	('NV012','CN003',N'Tr­ơng Thị',N'Hằng','24/6/1986',N'Nữ','983412681',N'TP.HCM','0974808483','hang@gmail.com',6000000),
	('NV013','CN003',N'Bùi',N'H­ơng','7/8/1986',N'Nam','978366465',N'Long An','985988018','hong86@gmail.com',6000000),
	('NV014','CN003',N'Hồ Thị Mai',N'H­ơng','23/10/1985',N'Nữ','988585568',N'Tây Ninh','0977022810','hong@gmail.com',8000000),
	('NV015','CN003',N'Lê Thị Mai',N'Huyên','10/4/1986',N'Nữ','916175566',N'TP.HCM','01698203985','huyen@gmail.com',8000000),
	('NV016','CN004',N'Nguyễn Thị',N'Hà','6/1/1976',N'Nữ','987898882',N'Cao Sơn','01674519611','ha@gmail.com',6000000),
	('NV017','CN004',N'Vũ Thanh',N'Hải','4/12/1988',N'Nam','982527982',N'TP.HCM','0905516826','hai@gmail.com',8000000),
	('NV018','CN004',N'Giản Thị',N'Hảo','9/7/1986',N'Nữ','973776072',N'Long An','01649615261','hao@gmail.com',5500000),
	('NV019','CN004',N'Chu Thị',N'Hiền','28/11/1987',N'Nữ','917749254',N'Cần Thơ','0979006323','hien@gmail.com',5500000),
	('NV020','CN005',N'Nguyễn Thị Ngọc',N'Hà','20/12/1984',N'Nữ','904770053',N'TP.HCM','0978140196','hangoc@gmail.com',8000000),
	('NV021','CN005',N'Lê Duyên',N'Nhung','28/4/1984',N'Nam','974880788',N'TP.HCM','0979879310','nhung@gmail.com',5500000),
	('NV022','CN005',N'L­u Thị',N'Ninh','20/9/1983',N'Nữ','983730984',N'Long An','0989352144','ninh@gmail.com',5500000),
	('NV023','CN005',N'L­ơng Thị Thảo',N'Quyên','22/7/1988',N'Nữ','983888611',N'Cần Thơ','01274543993','quyenthao@gmail.com',8000000),
	('NV024','CN006',N'Nguyễn Thu',N'Quyên','5/4/1982',N'Nữ','984603663',N'TP.HCM','0986728217','quyen@gmail.com',8000000),
	('NV025','CN006',N'Phùng Thị',N'Nhung','7/3/1985',N'Nữ','986375176',N'TP.HCM','0977311312','nhung@gmail.com',6000000),
	('NV026','CN006',N'Đỗ',N'Tân','26/12/1982',N'Nam','914770545',N'Cần Thơ','01292042096','tan@gmail.com',6000000),
	('NV027','CN006',N'Phạm Thị',N'Thảo','14/4/1978',N'Nữ','986253482',N'Long An','0984200935','thao78@gmail.com',5500000),
	('NV028','CN007',N'V­ơng Thị',N'Thảo','2/8/1986',N'Nữ','944545232',N'Đồng Tháp','0977652886','thao114@gmail.com',5500000),
	('NV029','CN007',N'Lê Thu',N'Thảo','4/4/1988',N'Nam','912644784',N'Đồng Tháp','0942116052','thao@gmail.com',6500000),
	('NV030','CN007',N'Nguyễn Minh',N'Thuỷ','14/11/1988',N'Nữ','1668890843',N'TP.HCM','0986561497','thuyngoc@gmail.com',6500000),
	('NV031','CN007',N'Vũ Thị',N'Thuý','15/9/1985',N'Nữ','966219941',N'Cao Lãnh','0972544485','thuy@gmail.com',6500000),
	('NV032','CN008',N'Nguyễn Thị',N'Thuận','3/9/1986',N'Nữ','987214082',N'Đồng Tháp','0975296509','thuan@gmail.com',6500000),
	('NV033','CN008',N'Cao Thị',N'Tú','1/7/1983',N'Nữ','1634229954',N'TP.HCM','0974552551','tu@gmail.com',8000000),
	('NV034','CN008',N'Trần Thị Mỹ',N'Tiệp','26/6/1981',N'Nữ','1672377922',N'An Giang','01686979170','tiep@gmail.com',6000000),
	('NV035','CN008',N'Nguyễn Ph­ơng',N'Việt','3/8/1988',N'Nam','1674269375',N'Cần Thơ','01686915981','viet@gmail.com',8000000)


INSERT INTO THETHANHVIEN(SOTHE,MAKH,TONGDIEM)
VALUES (4536676,'KH002',0),
	(1234567,'KH005',0),
	(9966551,'KH021',0),
	(2255668,'KH014',12),
	(1123247,'KH018',99),
	(9999999,'KH020',0),
	(6699447,'KH029',12),
	(2341278,'KH016',45),
	(5677299,'KH022',34),
	(2556821,'KH027',67),
	(4468778,'KH009',0),
	(8753422,'KH010',78),
	(1389090,'KH012',66),
	(0065242,'KH011',67),
	(4387832,'KH020',12)
	
INSERT INTO PHUCAP
VALUES('PC001',N'Hỗ trợ nhà ở',1000000),
	('PC002',N'Hỗ trợ nghĩ phụ sản',200000),
	('PC003',N'Trợ cấp ăn trưa',500000),
	('PC004',N'Trợ cấp di chuyển',1000000),
	('PC005',N'Bảo hiểm thân thể',1200000)

INSERT INTO LOAIMON
VALUES('LM001',N'Trà'),
	('LM002',N'Cafe'),
	('LM003',N'Trà Sữa'),
	('LM004',N'Nước Trái Cây')


INSERT INTO MON
VALUES('M001',N'Cafe đen đá','LM002',7000),
	('M002',N'Cafe sữa nóng','LM002',20000),
	('M003',N'Cafe sữa đá','LM002',25000),
	('M004',N'Cabochino','LM002',32000),
	('M005',N'Cafe đen nóng','LM002',15000),
	('M006',N'Trà lá tươi nóng','LM001',35000),
	('M007',N'Trà atiso','LM001',65000),
	('M008',N'Trà đậu','LM001',65000),
	('M009',N'Trà nhị sen','LM001',55000),
	('M010',N'Trà sữa đặc biệt phúc long','LM003',65000),
	('M011',N'Trà sữa chân châu đường đen','LM003',55000),
	('M012',N'Trà sữa hoàng kim','LM003',45000),
	('M013',N'Trà sữa yến mạch','LM003',35000),
	('M014',N'Trà sữa hồng đào','LM003',35000),
	('M015',N'Trà sữa chân châu trắng','LM003',55000),
	('M016',N'Trà sữa bánh plan','LM003',45000),
	('M017',N'Trà sữa kem trứng','LM003',55000)
	


INSERT INTO HOADON(SOHD,MANV,MAKH,NGAYLAP,UUDAI)
VALUES('HD0001','NV001','KH002','29/10/2021',1),
	('HD0002','NV001','KH005','14/3/2022',0),
	('HD0003','NV003','KH004','20/12/2021',1),
	('HD0004','NV003','KH008','27/5/2021',1),
	('HD0005','NV003','KH007','10/3/2022',0),
	('HD0006','NV006','KH009','11/6/2021',1),
	('HD0007','NV006','KH025','2/1/2022',0),
	('HD0008','NV007','KH017','1/12/2021',0),
	('HD0009','NV009','KH018','24/6/86',1),
	('HD0010','NV010','KH019','7/8/2021',0),
	('HD0011','NV014','KH016','23/10/2021',1),
	('HD0012','NV017','KH013','10/4/2021',0),
	('HD0013','NV012','KH022','6/1/2022',0),
	('HD0014','NV011','KH012','4/12/2021',1),
	('HD0015','NV017','KH020','9/7/2021',0),
	('HD0016','NV001','KH025','29/10/2021',1)


INSERT INTO CT_HUONGPHUCAP
VALUES('PC001','NV001'),
	('PC001','NV012'),
	('PC002','NV012'),
	('PC003','NV012'),
	('PC004','NV004'),
	('PC003','NV006'),
	('PC003','NV008'),
	('PC001','NV009'),
	('PC004','NV010'),
	('PC001','NV018'),
	('PC002','NV022'),
	('PC001','NV026'),
	('PC003','NV029'),
	('PC004','NV031'),
	('PC005','NV023'),
	('PC005','NV025'),
	('PC001','NV025'),
	('PC001','NV022'),
	('PC004','NV017')


INSERT INTO CT_HOADON
VALUES('HD0001','M001',2,14000),
	('HD0001','M002',1,20000),
	('HD0001','M003',3,21000),
	('HD0002','M011',4,220000),
	('HD0003','M012',2,90000),
	('HD0004','M004',1,32000),
	('HD0005','M006',2,70000),
	('HD0005','M007',1,65000),
	('HD0005','M001',1,7000),
	('HD0006','M004',2,64000),
	('HD0006','M008',2,130000),
	('HD0007','M002',1,20000),
	('HD0007','M006',1,35000),
	('HD0008','M009',4,220000),
	('HD0008','M013',2,70000),
	('HD0009','M007',2,130000),
	('HD0009','M015',1,55000)

SELECT* FROM CT_HUONGPHUCAP
-----------------------------TRUY VẤN BÌNH THƯỜNG

--câu 1 : LIỆT KÊ CÁC KHÁCH HÀNG CÓ ĐĂNG KÝ THẺ THÀNH VIÊN CÓ TỔNG ĐIỂM LỚN HƠN 10 GỒM: HỌ TÊN KHÁCH HÀNG, ĐỊA CHỈ, SDT, TỔNG ĐIỂM THẺ, sẮP XẾP TĂNG DẦN THEO TỔNG ĐIỂM 

SELECT HoKH+' '+TenKH AS N'Họ Tên khách hàng',SDT,DiaChi,TONGDIEM
FROM KHACHHANG JOIN THETHANHVIEN on KHACHHANG.MaKH=THETHANHVIEN.MAKH
WHERE TONGDIEM > 50
ORDER BY TONGDIEM ASC

--CÂU 2: LIỆT KÊ DANH SÁCH CÁC NHÂN VIÊN ĐƯỢC HƯỞNG CÁC LOẠI PHỤ CẤP THÔNG TIN GỒM: HỌ TÊN NV,GIỚI TÍNH, MÃ CHI NHÁNH, LƯƠNG CB, TÊN PHỤ CẤP   
SELECT HoNV+' '+TenNV AS N'HỌ TÊN NHÂN VIÊN',GioiTinhNV,MaCN,LUONGCB,TENPHUCAP
FROM PHUCAP JOIN CT_HUONGPHUCAP ON PHUCAP.MAPHUCAP=CT_HUONGPHUCAP.MAPHUCAP 
			JOIN NHANVIEN ON NHANVIEN.MaNV=CT_HUONGPHUCAP.MANV

--CÂU 3: LIỆT KÊ DANH SÁCH KHÁCH HÀNG MUA VÀO THÁNG 5/2020 GỒM: HỌ TÊN KHÁCH HÀNG, NGÀY LẬP HÓA ĐON, MÃ NHÂN VIÊN, TỔNG TIỀN HÓA ĐƠN

SELECT HoKH+' '+TenKH AS N'HỌ TÊN KHÁCH HÀNG', NGAYLAP, MANV,TONGTIEN
FROM KHACHHANG JOIN HOADON ON KHACHHANG.MaKH=HOADON.MAKH
WHERE (MONTH(NGAYLAP)=3 AND YEAR(NGAYLAP)=2022)

--CÂU 4: Liệt kê các khách hàng từng đến mua hàng ở chi nhánh quận tân phú: hộ tên khách hàng, tên nhân viên lập, tên chi nhánh
SELECT HoKH+' '+TenKH AS N'HỌ TÊN KHÁCH HÀNG', HoNV+' '+TenNV AS N'HỌ TÊN NHÂN VIÊN',TenCN
FROM KHACHHANG INNER JOIN HOADON ON KHACHHANG.MaKH=HOADON.MAKH
			   INNER JOIN NHANVIEN ON NHANVIEN.MaNV=HOADON.MANV 
			   INNER JOIN CHINHANH ON CHINHANH.MaCN=NHANVIEN.MaCN
WHERE (TenCN LIKE '%Tân Phú')


--CÂU 5: LIỆT KÊ CÁC MÓN THUỘC LOẠI TRÀ SỮA: MÃ MÓN, TÊN MÓN, TÊN LOẠI MÓN
SELECT MAMON,TENMON,TENLOAIMON
FROM LOAIMON JOIN MON ON LOAIMON.MALOAIMON=MON.MALOAIMON
WHERE TENLOAIMON = N'TRÀ SỮA'

-----------------------------TRUY VẤN THỐNG KÊ
--CÂU 1: THỐNG KÊ SỐ LƯỢNG NHÂN VIÊN CỦA TỪNG CHI NHÁNH, SẮP XẾP TĂNG DẦN THEO SỐ LƯỢNG NHÂN VIÊN THÔNG TIN GỒM: TÊN CHI NHÁNH, SỐ LƯỢNG NHÂN VIÊN
SELECT TenCN, COUNT(MaNV) AS N'SỐ NHÂN VIÊN'
FROM CHINHANH JOIN NHANVIEN ON NHANVIEN.MaCN=CHINHANH.MaCN
GROUP BY TenCN
ORDER BY COUNT(MANV) ASC

--CÂU 2: THỐNG KÊ SỐ LƯỢNG KHÁCH HÀNG NỮ ĐÃ ĐĂNG KÝ THẺ THÀNH VIÊN 
SELECT COUNT(THETHANHVIEN.MaKH) AS N'SỐ LƯỢNG THÀNH VIÊN NỮ'
FROM THETHANHVIEN JOIN KHACHHANG ON THETHANHVIEN.MAKH=KHACHHANG.MaKH
WHERE GioiTinh=N'NỮ'
GROUP BY GioiTinh

--CÂU 3: Thống kê số lượng khách hàng đến mua hàng các tháng trong năm 2021
SELECT MONTH(NGAYLAP) AS N'THÁNG', COUNT(MAKH) AS N'SỐ LƯỢNG KHÁCH HÀNG MUA'
FROM HOADON
WHERE YEAR(NGAYLAP) =2021
GROUP BY MONTH(NGAYLAP)

--CÂU 4: Thống kê số lần của các nhân viên từng lập hóa đơn từ năm 2020 đến 2022: Mã nhân viên, họ và tên, số lần lập, thống kê từ cao xuống thấp theo số lần lập
SELECT NHANVIEN.MaNV, HoNV+' '+TenNV AS N'HỌ TÊN NHÂN VIÊN', COUNT(SOHD) AS N'SỐ LƯỢNG HÓA ĐƠN LẬP'
FROM NHANVIEN JOIN HOADON ON NHANVIEN.MaNV=HOADON.MANV
WHERE YEAR (NGAYLAP) BETWEEN 2020 AND 2022
GROUP BY NHANVIEN.MaNV,HoNV,TenNV 
ORDER BY COUNT(SOHD) DESC

--CÂU 5: THỐNG KÊ SỐ LƯỢNG KHÁCH ĐẾN MUA NƯỚC Ở CHI NHÁNH SẮP GIẢM DẪN THEO SỐ LƯỢNG

SELECT TenCN, COUNT(MAKH) AS N'SỐ LƯỢNG KHÁCH ĐẾN MUA'
FROM CHINHANH JOIN NHANVIEN ON CHINHANH.MaCN=NHANVIEN.MaCN JOIN HOADON ON HOADON.MANV= NHANVIEN.MaNV
GROUP BY TENCN
ORDER BY COUNT(MAKH) DESC

--CÂU 6: THỐNG KÊ TRUNG BÌNH GIÁ CỦA CÁC LOẠI MÓN TRONG QUÁN ĐANG BÁN
SELECT TENLOAIMON, AVG(GIABAN) AS N'TRUNG BÌNH GIÁ'
FROM MON JOIN LOAIMON ON MON.MALOAIMON=LOAIMON.MALOAIMON
GROUP BY TENLOAIMON

--CÂU 7: THỐNG KÊ TỔNG TIỀN HÓA ĐƠN CỦA CÁC KHÁCH HÀNG ĐÃ ĐẾN MUA HÀNG SẮP GIẢM DẦN THEO TỔNG TIỀN
SELECT  HoKH+' '+TenKH AS N'Họ Tên khách hàng', SUM(THANHTIEN) AS N'TỔNG TIỀN HÓA ĐƠN'
FROM KHACHHANG JOIN HOADON ON KHACHHANG.MaKH=HOADON.MAKH
			   JOIN CT_HOADON ON HOADON.SOHD=CT_HOADON.SOHD 
			   JOIN MON ON MON.MAMON=CT_HOADON.MAMON

GROUP BY HoKH,TenKH
ORDER BY SUM(THANHTIEN) DESC
-----------------------------TRUY VẤN LỒNG

--CÂU 1: Khách hàng có nhiều hóa đơn nhất 
SELECT HoKH+' '+TenKH AS N'HỌ TÊN KHÁCH HÀNG', COUNT(SOHD) AS N'SỐ LƯỢNG SỐ ĐƠN ĐÃ MUA'
FROM KHACHHANG JOIN HOADON ON KHACHHANG.MaKH=HOADON.MAKH
GROUP BY HoKH,TenKH
HAVING COUNT(SOHD) >=ALL (SELECT COUNT(SOHD) FROM HOADON GROUP BY MAKH)

--CÂU 2: Danh sách các khách hàng đã đăng ký thẻ thành viên chưa có hóa đơn

SELECT HoKH+' '+TenKH AS N'HỌ TÊN KHÁCH HÀNG'
FROM KHACHHANG
WHERE MaKH NOT IN (SELECT MAKH
					FROM THETHANHVIEN
					WHERE KHACHHANG.MaKH=THETHANHVIEN.MAKH)

--CÂU 3: Liệt kê các nhân viên chưa từng lập hóa đơn

SELECT HoNV+' '+TenNV AS N'HỌ TÊN NHÂN VIÊN', TENCN
FROM NHANVIEN JOIN CHINHANH ON NHANVIEN.MaCN=CHINHANH.MaCN
WHERE MaNV NOT IN (SELECT MANV
					FROM HOADON
					WHERE NHANVIEN.MaNV=HOADON.MANV)

--CÂU 4: Lệt kê TOP 2 CHI NHÁNH CÓ NHIỀU NHÂN VIÊN LẬP HÓA ĐƠN NHẤT

SELECT TOP 2 TenCN, COUNT(MaNV) AS N'SỐ NHÂN VIÊN LẬP HÓA ĐƠN'
FROM CHINHANH JOIN NHANVIEN ON CHINHANH.MaCN=NHANVIEN.MaCN
WHERE MaNV IN (SELECT MaNV FROM HOADON)
GROUP BY TenCN
ORDER BY COUNT(MANV) DESC


-----------------------------TẠO SYNONYM CHO CÁC TABLE
CREATE SYNONYM NV FOR NHANVIEN

CREATE SYNONYM KH FOR KHACHHANG

CREATE SYNONYM CN FOR CHINHANH

CREATE SYNONYM LM FOR LOAIMON

CREATE SYNONYM M FOR MON

CREATE SYNONYM PC FOR PHUCAP

CREATE SYNONYM TTV FOR THETHANHVIEN

CREATE SYNONYM HD FOR HOADON

CREATE SYNONYM CTHD FOR CT_HOADON

CREATE SYNONYM CTPC FOR CT_HUONGPHUCAP

--TEST
SELECT *FROM NV

SELECT *FROM KH

SELECT *FROM LM

SELECT *FROM M

SELECT *FROM HD

SELECT *FROM CTHD

SELECT *FROM CTPC

SELECT *FROM TTV

SELECT *FROM CN

SELECT *FROM PC

-----------------------------TẠO INDEX
--
CREATE INDEX ID_KH ON KHACHHANG(TENKH)

SELECT*FROM KHACHHANG 
WITH (INDEX(ID_KH))
WHERE TenKH LIKE 'TH%'

--
CREATE INDEX ID_NV ON NHANVIEN(GIOITINHNV,NGAYSINH)

SELECT*FROM NHANVIEN
WITH (INDEX (ID_NV))
WHERE GioiTinhNV=N'NỮ' AND (YEAR(GETDATE()) - YEAR(NgaySinh))>=40

--

CREATE INDEX ID_CTHD ON CT_HOADON(THANHTIEN)

SELECT* FROM CT_HOADON
WITH (INDEX(ID_CTHD))
WHERE THANHTIEN >100000

-----------------------------TẠO VIEW

--CÂU 1: Danh sách nhân viên nam quê ở đồng tháp

CREATE VIEW DS_NV_NAM_DONGTHAP_VIEW
AS
	SELECT *
	FROM NHANVIEN
	WHERE GioiTinhNV='NAM' AND DiaChi=N'ĐỒNG THÁP'

-- GỌI LẠI VIEW
SELECT* FROM DS_NV_NAM_DONGTHAP_VIEW

--CÂU 2: Danh sách nhân viên của chi nhánh quận tân phú

CREATE VIEW DS_NV_QTANPHU_VIEW
AS
	SELECT HoNV+' '+TenNV AS N'HỌ VÀ TÊN NHÂN VIÊN', TenCN
	FROM CHINHANH JOIN NHANVIEN ON CHINHANH.MaCN=NHANVIEN.MaCN
	WHERE CHINHANH.DiaChi LIKE '%TÂN PHÚ'

-- GỌI LẠI VIEW
SELECT* FROM DS_NV_QTANPHU_VIEW

--CÂU 3: Danh sách khách hàng mua từ 2 hóa đơn trở lên

CREATE VIEW DS_KH_2HD_VIEW
AS
	SELECT HoKH +' '+TenKH AS N'HỌ TÊN KHÁCH', COUNT(SOHD) AS N'SỐ HOÁN ĐƠN TỪNG MUA'
	FROM HOADON JOIN KHACHHANG ON KHACHHANG.MaKH=HOADON.MAKH
	GROUP BY HoKH,TenKH
	HAVING COUNT(SOHD) >=2

-- GỌI LẠI VIEW
SELECT* FROM DS_KH_2HD_VIEW

--CÂU 4: Danh sách các khách hàng từng mua có hóa đơn do nhân viên tên dũng lập 

CREATE VIEW DS_KH_NV_TUAN_VIEW
AS
	SELECT HoKH +' '+TenKH AS N'HỌ TÊN KHÁCH', TENNV
	FROM KHACHHANG JOIN HOADON ON KHACHHANG.MaKH=HOADON.MAKH 
					JOIN NHANVIEN ON NHANVIEN.MaNV=HOADON.MANV
	WHERE TenNV=N'DŨNG'

-- GỌI LẠI VIEW
SELECT* FROM DS_KH_NV_TUAN_VIEW

-----------------------------TẠO FUNCTION

--CÂU 1: DANH SÁCH KHÁCH HÀNG TỪNG MUA THEO NĂM ĐƯỢC TRUYỀN VÀO
CREATE FUNCTION FN_DSKH_THEONAM (@NAM INT)
RETURNS TABLE
AS
RETURN
	SELECT HoKH+' '+TenKH AS N'HỌ VÀ TÊN KHÁCH HÀNG', NGAYLAP AS N'NGÀY MUA'
	FROM HOADON JOIN KHACHHANG ON KHACHHANG.MaKH=HOADON.MAKH
	WHERE @NAM=YEAR(NGAYLAP)


-- GỌI HÀM
SELECT*FROM FN_DSKH_THEONAM(2021)

--CÂU 2: SỐ LƯỢNG MÓN ĂN THEO MÃ LOẠI ĐƯỢC TRUYỀN VÀO

CREATE FUNCTION FN_SLMON_THEOMALOAI (@MALOAIMON VARCHAR(20))
RETURNS INT 
AS
BEGIN
	DECLARE @SOLUONG INT;
	SELECT @SOLUONG=COUNT(MAMON)
	FROM MON JOIN LOAIMON ON MON.MALOAIMON=LOAIMON.MALOAIMON
	WHERE LOAIMON.MALOAIMON=@MALOAIMON
	RETURN @SOLUONG;
END


-- GỌI HÀM
PRINT DBO.FN_SLMON_THEOMALOAI('LM002')

--CÂU 3: CHO BIẾT DANH SÁCH NHÂN VIÊN THEO ĐIỀU KIỆN GIỚI TÍNH VÀ MÃ CHI NHÁNH ĐƯỢC TRUYỀN VÀO

CREATE FUNCTION FN_DSNV_GIOITINH (@GT NVARCHAR(20),@MaCN NVARCHAR(20))
RETURNS TABLE
AS
RETURN
	SELECT HoNV+' '+TenNV AS N'HỌ VÀ TÊN NHÂN VIÊN'
	FROM NHANVIEN
	WHERE GioiTinhNV=@GT AND MaCN=@MaCN


-- GỌI HÀM
SELECT *FROM FN_DSNV_GIOITINH(N'NAM','CN001')

-----------------------------TRUY STORE PROCEDURE

--CÂU 1: THỦ TỤC KIỂM TRA TRÙNG KHÓA CHÍNH THI THÊM MỚI LOẠI MÓN

CREATE PROC KiemtraPK_LoaiMON
	(
		@MALOAI nchar(30),
		@TENLOAI nvarchar(100)
	)
AS
BEGIN
	IF NOT EXISTS (SELECT *FROM LOAIMON where MALOAIMON=@MALOAI)
		BEGIN
			INSERT LOAIMON(MALOAIMON,TENLOAIMON)
			VALUES (@MALOAI,@TENLOAI)
		END
	ELSE
		BEGIN 
			RAISERROR (N'TRÙNG KHÓA CHÍNH',11,1);
		END
END;

-- GỌI HÀM
-- Thử trường hợp khóa chính đã có rồi
EXEC KiemtraPK_LoaiMON 'LM001' ,N'NƯỚC NGỌT'

-- Trường hợp khóa chính chưa có
EXEC KiemtraPK_LoaiMON 'LM005' ,N'NƯỚC NGỌT' 

--CÂU 2: THỦ TỤC KIỂM TRA KHÓA NGOẠI KHI THÊM MỚI MỘT MÓN

CREATE PROC THEMMON
	(
		@MAMON VARCHAR(30),
		@TENMON NVARCHAR(100),
		@MALOAI VARCHAR(30),
		@GIABAN FLOAT
	)
AS
BEGIN
	IF EXISTS (SELECT *FROM LOAIMON where MALOAIMON=@MALOAI)
		BEGIN
			INSERT MON(MAMON,TENMON,MALOAIMON,GIABAN)
			VALUES (@MAMON,@TENMON,@MALOAI,@GIABAN)
		END
	ELSE
		BEGIN 
			RAISERROR (N'KHÔNG TÌM THẤY  MÃ LOẠI MÓN BẠN NHẬP',11,1);
		END
END;

-- GỌI HÀM
-- Thử trường hợp khóa ngoại chưa tồn tại 
EXEC THEMMON 'M018' ,N'STING','LM006',12000

-- Trường hợp khóa ngoại đã tồn tại
EXEC THEMMON 'LM001' ,N'NƯỚC NGỌT','LM005',12000


--CÂU 3: CHO BIẾT THÔNG TIN KHÁCH HÀNG THEO MÃ TRUYỀN VÀO

CREATE PROC SP_TTKH @MAKH VARCHAR(30)
AS
	SELECT *
	FROM KHACHHANG
	WHERE MaKH=@MAKH

--GỌI THỦ TỤC

EXEC SP_TTKH 'KH001';

--CÂU 4: TẠO THỦ TỤC THỐNG KÊ DOANH THU THEO KHOẢNG THỜI GIAN TRUYỀN VÀO, THỜI GIAN BẮT ĐẦU VÀ THỜI GIAN KẾT THÚC THỐNG KÊ

CREATE PROC THONGKE_DOANHTHU
	@ThangDauVao DATETIME,
	@ThangCuoi DATETIME,
	@@TongDoanhThu FLOAT OUTPUT
	AS
	BEGIN
	IF (@ThangDauVao<=@ThangCuoi)
	BEGIN
		SELECT SUM (HOADON.TONGTIEN) AS N'TỔNG DOANH THU HỆ THỐNG'
		FROM HOADON 
		WHERE NGAYLAP>=@ThangDauVao AND NGAYLAP<=@ThangCuoi
		SELECT @@TongDoanhThu=(SELECT SUM (HOADON.TONGTIEN)
		FROM HOADON 
		WHERE NGAYLAP>=@ThangDauVao AND NGAYLAP<=@ThangCuoi);
	END; 
	ELSE
		PRINT N'THỜI GIAN BẮT ĐẦU SAU LỚN HƠN THỜI GIAN KẾT THÚC THẾ !!';
	END;


-- GỌI HÀM 
DECLARE @@TongDoanhThuShop FLOAT
EXEC THONGKE_DOANHTHU '04/11/2020','04/20/2022',@@TongDoanhThuShop
OUTPUT 
	IF(@@TongDoanhThuShop>100000)
		PRINT N'TỔNG DOANH THU TIỆM LÀ: '+Cast (@@TongDoanhThuShop AS NVARCHAR(100))
	ELSE
		PRINT N'TỔNG DOANH THU ÍT!!' 



-----------------------------TẠO TRIGGER

--CÂU 1: TRIGGER KIỂM TRA TUỔI NHÂN VIÊN KHI THÊM VÀO 
-- chỉ nhận nhân viên đủ 18t vào làm
	
CREATE TRIGGER KTTUOI ON NHANVIEN
AFTER INSERT
AS
	 BEGIN
	 DECLARE @TUOINV_MOI INT
	 SET @TUOINV_MOI = ( SELECT YEAR(GETDATE())-YEAR(NGAYSINH) from inserted)
	 IF (@TUOINV_MOI < 18)
		 BEGIN 
				RAISERROR (N'NHÂN VIÊN PHẢI LỚN HƠN 18 TUỔI',16,1);
		 END
	END
GO

-- TEST TRIGGER
--CHƯA ĐỦ 18T

INSERT INTO NHANVIEN(MaNV,MaCN,HoNV,TenNV,NgaySinh,GioiTinhNV,CMND,DiaChi,SDT,Email,LUONGCB)
VALUES('NV0111','CN001',N'Nguyễn Văn',N'AN','14/3/2019',N'Nam','114690835',N'Hà Nội','0975808375','chinh@gmail.com',8000000)

-- ĐỦ 18T
INSERT INTO NHANVIEN(MaNV,MaCN,HoNV,TenNV,NgaySinh,GioiTinhNV,CMND,DiaChi,SDT,Email,LUONGCB)
VALUES('NV0111','CN001',N'Nguyễn Văn',N'AN','14/3/2000',N'Nam','114690835',N'Hà Nội','0975808375','chinh@gmail.com',8000000)

select*from NHANVIEN where MaNV='NV0111'


--CÂU 2: TRIGGER TỰ ĐỘNG CẬP NHẬT TỔNG TIỀN HÓA ĐƠN KHI THÊM CHI TIẾT HÓA ĐƠN

CREATE TRIGGER trg_TinhTongTienHD ON CT_HOADON AFTER INSERT AS
BEGIN 
	UPDATE HOADON
	SET TONGTIEN = TONGTIEN+(
	SELECT THANHTIEN
	FROM inserted
	WHERE SOHD=HOADON.SOHD
	)
FROM HOADON,inserted
WHERE HOADON.SOHD=inserted.SOHD
END;

update HOADON
set TONGTIEN=0

-- TEST TRIGGER
SELECT* FROM HOADON WHERE SOHD='HD0016'

--THÊM CT_HOADON CHO HÓA ĐƠN CÓ SỐ HD0016
INSERT INTO CT_HOADON
VALUES('HD0016','M001',2,14000)


--CÂU 3:TRIGGER TỰ ĐỘNG CẬP NHẬT TỔNG TIỀN HÓA ĐƠN KHI XÓA CHI TIẾT HÓA ĐƠN

CREATE TRIGGER trg_XOATinhTongTienHD ON CT_HOADON FOR DELETE AS
BEGIN 
	UPDATE HOADON
	SET TONGTIEN = TONGTIEN-(
	SELECT THANHTIEN
	FROM deleted
	WHERE SOHD=HOADON.SOHD
	)
FROM HOADON,deleted
WHERE HOADON.SOHD=deleted.SOHD
END;


--CHƯA XÓA CHI TIẾT HÓA ĐƠN
SELECT*FROM HOADON WHERE SOHD='HD0016'

--SAU KHI XÓA CT_HOADON CHO HÓA ĐƠN CÓ SỐ HD0016

DELETE FROM CT_HOADON WHERE SOHD='HD0016'


SELECT*FROM HOADON WHERE SOHD='HD0016'


--CÂU 4:TRIGGER TỰ ĐỘNG CẬP NHẬT TỔNG TIỀN HÓA ĐƠN KHI SỬA CHI TIẾT HÓA ĐƠN

CREATE TRIGGER trg_CNTinhTongTienHD ON CT_HOADON AFTER UPDATE AS
BEGIN 
	UPDATE HOADON
	SET TONGTIEN = TONGTIEN-(
	SELECT THANHTIEN
	FROM inserted
	WHERE SOHD=HOADON.SOHD) +

	(SELECT THANHTIEN
	FROM deleted
	WHERE SOHD=HOADON.SOHD)

FROM HOADON,deleted
WHERE HOADON.SOHD=deleted.SOHD
END;

-- TRƯỚC KHI CHƯA UPDATE

SELECT*FROM HOADON WHERE SOHD='HD0016'

--SAU KHI SỬA CT_HOADON CHO HÓA ĐƠN CÓ SỐ HD0016

UPDATE CT_HOADON
SET SOLUONG=3
WHERE SOHD='HD0016' AND MAMON='M001'

UPDATE CT_HOADON
SET THANHTIEN=SOLUONG*GIABAN
FROM CT_HOADON JOIN MON ON MON.MAMON=CT_HOADON.MAMON
WHERE SOHD='HD0016' AND CT_HOADON.MAMON='M001'


SELECT*FROM HOADON WHERE SOHD='HD0016'

--CÂU 5:TRIGGER XÓA KHÓA NGOẠI

CREATE TRIGGER trg_XoaHD ON HOADON
instead of delete
AS
begin
    DELETE FROM CT_HOADON
    WHERE exists (SELECT SOHD FROM deleted where deleted.SOHD = CT_HOADON.SOHD)
	DELETE FROM HOADON
	WHERE EXISTS (SELECT SOHD FROM deleted WHERE deleted.SOHD = HOADON.SOHD)
end
GO


-- TEST KHI HÓA ĐI HÓA ĐƠN NÀO THÌ CHI TIẾT HÓA ĐƠN ĐÓ CŨNG TỰ ĐƯỢC XÓA
DELETE FROM HOADON WHERE SOHD='HD0016'

--
SELECT*FROM HOADON  WHERE SOHD='HD0016'
SELECT*FROM CT_HOADON  WHERE SOHD='HD0016'

--CÂU 6: TRIGGER KIỂM TRA SỐ LƯỢNG MUA
--DÙNG KIỂM TRA KHI LẬP CHI TIẾT HÓA ĐƠN, KIỂM TRA SỐ LƯỢNG CỦA SẢN PHẨM ĐƯỢC MUA

CREATE TRIGGER KTSL_MUA ON CT_HOADON
AFTER INSERT
AS
	 BEGIN
	 DECLARE @SLMUA INT
	 SET @SLMUA = ( SELECT SOLUONG from inserted)
	 IF (@SLMUA <= 0)
		 BEGIN 
				RAISERROR (N'SỐ LƯỢNG MUA PHẢI LỚN HƠN 0',16,1)
		 END
	END
GO

--TEST
--CHO SỐ LƯỢNG MUA LÀ 0

INSERT INTO CT_HOADON
VALUES('HD0009','M002',0,14000)

-- CHO SỐ LƯỢNG MUA LỚN HƠN 0

INSERT INTO CT_HOADON
VALUES('HD0009','M002',2,14000)

-----------------------------TẠO USER 
-- TRƯỚC KHI CHẠY CÁC LỆNH TẠO USER & PHÂN QUYỀN CẦN CHUYỂN AVAILABLE DATABASES VỀ MASTER

--CÂU 1: TẠO USER QUẢN LÝ
CREATE LOGIN QLCF WITH PASSWORD = 'QL111', DEFAULT_DATABASE = QL_KH_CFPHUCLONG
CREATE USER QLCF FOR LOGIN QLCF

--CÂU 2: TẠO USER NHÂN VIÊN
CREATE LOGIN NVCF WITH PASSWORD = 'NV222', DEFAULT_DATABASE = QL_KH_CFPHUCLONG
CREATE USER NVCF FOR LOGIN NVCF

--CÂU 3:PHÂN QUYỀN CHO TÀI KHOẢN QUẢN LÝ

GRANT SELECT, INSERT, UPDATE, DELETE ON NHANVIEN TO QLCF
GRANT SELECT, INSERT, UPDATE, DELETE ON PHUCAP TO QLCF
GRANT SELECT, INSERT, UPDATE, DELETE ON KHACHHANG TO QLCF
GRANT SELECT, INSERT, UPDATE, DELETE ON THETHANHVIEN TO QLCF
GRANT SELECT, INSERT, UPDATE, DELETE ON CHINHANH TO QLCF
GRANT SELECT, INSERT, UPDATE, DELETE ON HOADON TO QLCF
GRANT SELECT, INSERT, UPDATE, DELETE ON MON TO QLCF
GRANT SELECT, INSERT, UPDATE, DELETE ON LOAIMON TO QLCF
GRANT SELECT, INSERT, UPDATE, DELETE ON CT_HOADON TO QLCF
GRANT SELECT, INSERT, UPDATE, DELETE ON CT_HUONGPHUCAP TO QLCF

--CÂU 4: PHÂN QUYỀN CHO TÀI KHOẢN NHÂN VIÊN

GRANT SELECT, INSERT, UPDATE, DELETE ON KHACHHANG TO NVCF
GRANT SELECT, INSERT, UPDATE, DELETE ON THETHANHVIEN TO NVCF
GRANT SELECT ON CHINHANH TO NVCF
GRANT SELECT, INSERT, UPDATE, DELETE ON HOADON TO NVCF
GRANT SELECT, DELETE ON MON TO NVCF
GRANT SELECT ON LOAIMON TO NVCF
GRANT SELECT, INSERT, UPDATE, DELETE ON CT_HOADON TO NVCF

